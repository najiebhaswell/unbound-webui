<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unbound DNS - Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
            color: #e4e4e4;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #00d9ff;
            font-size: 1.5rem;
        }

        .user-menu {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-menu span {
            color: #888;
            font-size: 0.85rem;
        }

        .btn-link {
            background: none;
            border: none;
            color: #00d9ff;
            cursor: pointer;
            font-size: 0.85rem;
            text-decoration: underline;
        }

        .btn-link:hover {
            color: #fff;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }

        .left-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-col {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(20, 30, 50, 0.8);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        .card h2 {
            font-size: 0.95rem;
            color: #00d9ff;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.active {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }

        .status-dot.inactive {
            background: #ff4444;
        }

        .graph-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .graph-title {
            font-size: 0.9rem;
            color: #00d9ff;
        }

        .graph-stats {
            display: flex;
            gap: 15px;
            font-size: 0.65rem;
        }

        .graph-stats span {
            color: #888;
        }

        .graph-stats .value {
            color: #fff;
            font-weight: bold;
        }

        .graph-controls {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .btn-range {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            padding: 4px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-range:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-range.active {
            background: rgba(0, 217, 255, 0.2);
            border-color: #00d9ff;
            color: #00d9ff;
        }

        #qpsChart {
            width: 100%;
            height: 250px;
        }

        .graph-legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.7rem;
            color: #888;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 3px;
            border-radius: 1px;
        }

        .legend-qps {
            background: #00d9ff;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #000;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffaa00, #ff7700);
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: #fff;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.7rem;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .scroll-table {
            max-height: 250px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        th,
        td {
            padding: 6px 4px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            color: #666;
            font-size: 0.7rem;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            background: rgba(20, 30, 50, 0.95);
        }

        .iface-name {
            font-family: monospace;
            color: #00d9ff;
            font-size: 0.7rem;
        }

        .iface-ip {
            font-family: monospace;
            font-size: 0.65rem;
        }

        .ipv4 {
            color: #aaa;
        }

        .ipv6 {
            color: #ff9800;
            font-size: 0.6rem;
        }

        .state-up {
            color: #00ff88;
        }

        .state-down {
            color: #ff4444;
        }

        input,
        select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .form-row {
            display: flex;
            gap: 8px;
        }

        .section-title {
            font-size: 0.75rem;
            color: #666;
            margin: 15px 0 8px;
            text-transform: uppercase;
        }

        .alert {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 0.85rem;
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.15);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .alert-error {
            background: rgba(255, 68, 68, 0.15);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .badge-allow {
            background: #00aa66;
            color: #fff;
        }

        .badge-deny {
            background: #ff4444;
            color: #fff;
        }

        .badge-refuse {
            background: #ffaa00;
            color: #000;
        }

        .acl-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .acl-network {
            font-family: monospace;
            font-size: 0.8rem;
        }

        .acl-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(20, 30, 50, 0.95);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(0, 217, 255, 0.3);
            width: 100%;
            max-width: 360px;
        }

        .modal-content h3 {
            color: #00d9ff;
            margin-bottom: 20px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #00d9ff;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üåê Unbound DNS Control Panel</h1>
            <div class="user-menu">
                <span>üë§ admin</span>
                <button class="btn-link" onclick="showPasswordModal()">Change Password</button>
                <button class="btn-link" onclick="logout()">Logout</button>
            </div>
        </div>

        <div id="alert" class="alert"></div>

        <div class="main-grid">
            <div class="left-col">
                <!-- Stats & Graph Card -->
                <div class="card">
                    <h2><span class="status-dot" id="statusDot"></span> Service Status</h2>
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-value" id="qps">-</div>
                            <div class="stat-label">Queries/sec</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalQueries">-</div>
                            <div class="stat-label">Total Queries</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="cacheHits">-</div>
                            <div class="stat-label">Cache Hits</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="uptime">-</div>
                            <div class="stat-label">Uptime</div>
                        </div>
                    </div>

                    <div class="graph-container">
                        <div class="graph-header">
                            <div class="graph-title">üìà QPS History</div>
                            <div class="graph-stats">
                                <span>Cur: <span class="value" id="graphCur">-</span></span>
                                <span>Min: <span class="value" id="graphMin">-</span></span>
                                <span>Avg: <span class="value" id="graphAvg">-</span></span>
                                <span>Max: <span class="value" id="graphMax">-</span></span>
                            </div>
                        </div>

                        <div class="graph-controls">
                            <button class="btn-range" onclick="setRange('1h')" data-range="1h">1h</button>
                            <button class="btn-range" onclick="setRange('12h')" data-range="12h">12h</button>
                            <button class="btn-range active" onclick="setRange('24h')" data-range="24h">24h</button>
                            <button class="btn-range" onclick="setRange('7d')" data-range="7d">7d</button>
                            <button class="btn-range" onclick="setRange('30d')" data-range="30d">30d</button>
                        </div>

                        <canvas id="qpsChart"></canvas>
                        <div class="graph-legend">
                            <div class="legend-item">
                                <div class="legend-color legend-qps"></div> Queries/sec
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="reload()">üîÑ Reload</button>
                        <button class="btn btn-warning" onclick="restart()">‚ö° Restart</button>
                    </div>
                </div>

                <!-- Interfaces Card -->
                <div class="card">
                    <h2>üîå Network Interfaces</h2>
                    <div class="scroll-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Interface</th>
                                    <th>IPv4</th>
                                    <th>IPv6</th>
                                    <th>State</th>
                                </tr>
                            </thead>
                            <tbody id="interfaceTable"></tbody>
                        </table>
                    </div>
                    <div class="section-title">Add IP Address</div>
                    <div class="form-row">
                        <select id="ifaceSelect" style="flex:1;"></select>
                        <input type="text" id="newIp" placeholder="IP (v4 or v6)" style="flex:2;">
                        <input type="text" id="newPrefix" placeholder="/24" value="24" style="flex:0.5;">
                    </div>
                    <button class="btn btn-primary" onclick="addIp()" style="width:100%;">‚ûï Add IP</button>
                </div>
            </div>

            <div class="right-col">
                <!-- Lamanlabuh Card -->
                <div class="card">
                    <h2>üö´ Lamanlabuh (Sinkhole)</h2>
                    <p style="font-size:0.75rem;color:#888;margin-bottom:15px;">
                        IP redirect untuk domain yang diblokir. Pisahkan dengan koma untuk multiple IP.
                    </p>
                    <div class="section-title">IPv4 Sinkhole (comma-separated)</div>
                    <input type="text" id="sinkholeIpv4" placeholder="103.217.209.188, 139.255.196.196, 182.23.79.195"
                        style="font-size:0.85rem;">
                    <div class="section-title">IPv6 Sinkhole (comma-separated)</div>
                    <input type="text" id="sinkholeIpv6" placeholder="2001:db8::1, 2001:db8::2"
                        style="font-size:0.85rem;">
                    <div class="btn-group" style="margin-top:15px;">
                        <button class="btn btn-primary" onclick="saveSinkhole()">üíæ Simpan</button>
                        <button class="btn btn-warning" onclick="fetchSinkhole()">üîÑ Refresh</button>
                    </div>
                </div>

                <!-- ACL Card -->
                <div class="card">
                    <h2>üîí Access Control</h2>
                    <div class="scroll-table" style="max-height:350px;">
                        <div id="aclList"></div>
                    </div>
                    <div class="section-title">Add ACL Rule</div>
                    <div class="form-row">
                        <input type="text" id="aclNetwork" placeholder="10.0.0.0/8 or 2001:db8::/32">
                        <select id="aclAction">
                            <option value="allow">Allow</option>
                            <option value="deny">Deny</option>
                            <option value="refuse">Refuse</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addAcl()" style="width:100%;">‚ûï Add Rule</button>
                </div>

                <!-- Domain Forwarder Card -->
                <div class="card">
                    <h2>üîÄ Domain Forwarder</h2>
                    <p style="font-size:0.75rem;color:#888;margin-bottom:10px;">
                        Forward domain tertentu ke resolver publik.<br>
                        Format: <code>domain,resolver1,resolver2,...</code>
                    </p>
                    <div class="scroll-table" style="max-height:200px;margin-bottom:10px;">
                        <div id="forwarderList"></div>
                    </div>
                    <div class="section-title">Add Forwarder</div>
                    <textarea id="forwarderInput" rows="2" placeholder="sipp.bpjsketenagakerjaan.go.id,1.1.1.1,8.8.8.8"
                        style="width:100%;font-size:0.85rem;font-family:monospace;"></textarea>
                    <div class="btn-group" style="margin-top:10px;">
                        <button class="btn btn-primary" onclick="addForwarder()">‚ûï Add</button>
                        <button class="btn btn-warning" onclick="fetchForwarders()">üîÑ Refresh</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>üîë Change Password</h3>
            <input type="password" id="currentPass" placeholder="Current Password">
            <input type="password" id="newPass" placeholder="New Password">
            <input type="password" id="confirmPass" placeholder="Confirm New Password">
            <div class="btn-group" style="margin-top:15px;">
                <button class="btn btn-primary" onclick="changePassword()">Save</button>
                <button class="btn btn-danger" onclick="hidePasswordModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let graphData = [];
        let graphStats = {};
        let currentRange = '24h';

        document.addEventListener('DOMContentLoaded', () => {
            fetchAll();
            setInterval(fetchStats, 5000);
            setInterval(fetchGraph, 10000);
            // Initial fetch
            setRange('24h');
        });

        async function fetchAll() { await Promise.all([fetchStats(), fetchInterfaces(), fetchAcl(), fetchSinkhole(), fetchForwarders(), fetchGraph()]); }

        function setRange(range) {
            currentRange = range;
            document.querySelectorAll('.btn-range').forEach(b => {
                b.classList.toggle('active', b.getAttribute('data-range') === range);
            });
            fetchGraph();
        }

        async function fetchStats() {
            try {
                const res = await fetch(API + '/api/stats');
                if (res.status === 401) { window.location.href = '/login'; return; }
                const data = await res.json();
                document.getElementById('qps').textContent = data.qps.toFixed(1);
                document.getElementById('totalQueries').textContent = formatNumber(data.total_queries);
                document.getElementById('cacheHits').textContent = formatNumber(data.cache_hits);
                document.getElementById('uptime').textContent = formatUptime(data.uptime);
                document.getElementById('statusDot').className = 'status-dot active';
            } catch (e) { document.getElementById('statusDot').className = 'status-dot inactive'; }
        }

        async function fetchGraph() {
            try {
                const res = await fetch(API + '/api/graph?period=' + currentRange);
                const data = await res.json();
                if (data.history) {
                    graphData = data.history;
                    graphStats = data.stats || {};
                    updateGraphStats();
                    drawChart();
                }
            } catch (e) { console.error('Graph fetch error:', e); }
        }

        function updateGraphStats() {
            document.getElementById('graphCur').textContent = graphStats.current?.toFixed(1) || '-';
            document.getElementById('graphMin').textContent = graphStats.min?.toFixed(1) || '-';
            document.getElementById('graphAvg').textContent = graphStats.avg?.toFixed(1) || '-';
            document.getElementById('graphMax').textContent = graphStats.max?.toFixed(1) || '-';
        }

        function drawChart() {
            const canvas = document.getElementById('qpsChart');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth;
            const h = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, w, h);
            if (graphData.length < 2) return;

            // Calculate scale
            const qpsValues = graphData.map(d => d.qps);
            const maxVal = Math.max(...qpsValues, 1);
            const minVal = 0; // Always start from 0 for cleaner look

            const padding = { top: 10, bottom: 20, left: 40, right: 10 };
            const graphW = w - padding.left - padding.right;
            const graphH = h - padding.top - padding.bottom;

            // Background
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(padding.left, padding.top, graphW, graphH);

            // Grid lines and Y Labels
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'right';

            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (graphH * i / 4);
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(w - padding.right, y);
                ctx.stroke();

                const val = maxVal - (maxVal - minVal) * i / 4;
                ctx.fillText(formatNumber(val), padding.left - 5, y + 3);
            }

            // Draw QPS line
            ctx.strokeStyle = '#00d9ff';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const step = graphW / (graphData.length - 1);
            graphData.forEach((d, i) => {
                const x = padding.left + i * step;
                const y = padding.top + graphH - ((d.qps - minVal) / (maxVal - minVal || 1)) * graphH;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Fill area
            ctx.lineTo(padding.left + graphW, padding.top + graphH);
            ctx.lineTo(padding.left, padding.top + graphH);
            ctx.fillStyle = 'rgba(0,217,255,0.15)';
            ctx.fill();

            // X-axis time labels (simplified)
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            const labelCount = 5;
            for (let i = 0; i <= labelCount; i++) {
                const idx = Math.floor(i * (graphData.length - 1) / labelCount);
                if (graphData[idx]) {
                    const x = padding.left + idx * step;
                    const time = new Date(graphData[idx].time * 1000);

                    let label;
                    if (currentRange === '1h' || currentRange === '12h' || currentRange === '24h') {
                        label = time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                    } else {
                        label = time.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                    ctx.fillText(label, x, h - 5);
                }
            }
        }

        function formatUptime(seconds) {
            if (seconds >= 86400) {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                return `${days}d ${hours}h`;
            } else if (seconds >= 3600) {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${mins}m`;
            } else {
                return `${Math.floor(seconds / 60)}m`;
            }
        }

        async function fetchInterfaces() {
            try {
                const res = await fetch(API + '/api/interfaces');
                const data = await res.json();
                const tbody = document.getElementById('interfaceTable');
                const select = document.getElementById('ifaceSelect');
                tbody.innerHTML = ''; select.innerHTML = '';

                data.interfaces.forEach(iface => {
                    const ipv4 = iface.addresses.filter(a => a.family === 'inet').map(a => `${a.ip}/${a.prefix}`).join('<br>') || '-';
                    const ipv6 = iface.addresses.filter(a => a.family === 'inet6').map(a => `${a.ip}/${a.prefix}`).join('<br>') || '-';
                    const stateClass = iface.state === 'UP' ? 'state-up' : 'state-down';
                    tbody.innerHTML += `<tr>
                        <td class="iface-name">${iface.name}</td>
                        <td class="iface-ip ipv4">${ipv4}</td>
                        <td class="iface-ip ipv6">${ipv6}</td>
                        <td class="${stateClass}">${iface.state}</td>
                    </tr>`;
                    select.innerHTML += `<option value="${iface.name}">${iface.name}</option>`;
                });
            } catch (e) { console.error('Interface fetch error', e); }
        }

        async function fetchAcl() {
            try {
                const res = await fetch(API + '/api/acl');
                const data = await res.json();
                const list = document.getElementById('aclList');
                list.innerHTML = '';
                data.acl.forEach(rule => {
                    list.innerHTML += `<div class="acl-row">
                        <span class="acl-network">${rule.network}</span>
                        <div class="acl-actions">
                            <span class="badge badge-${rule.action}">${rule.action}</span>
                            <button class="btn btn-danger btn-sm" onclick="removeAcl('${rule.network}')">‚úï</button>
                        </div>
                    </div>`;
                });
            } catch (e) { console.error('ACL fetch error', e); }
        }

        async function fetchSinkhole() {
            try {
                const res = await fetch(API + '/api/sinkhole');
                const data = await res.json();
                document.getElementById('sinkholeIpv4').value = data.ipv4 || '';
                document.getElementById('sinkholeIpv6').value = data.ipv6 || '';
            } catch (e) { console.error('Sinkhole fetch error', e); }
        }

        async function saveSinkhole() {
            const ipv4 = document.getElementById('sinkholeIpv4').value;
            const ipv6 = document.getElementById('sinkholeIpv6').value;
            const res = await fetch(API + '/api/sinkhole', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ipv4, ipv6 })
            });
            const data = await res.json();
            if (data.success) {
                showAlert('Sinkhole IP tersimpan! Reload untuk menerapkan.', 'success');
            } else {
                showAlert(data.error || 'Gagal menyimpan', 'error');
            }
        }

        async function fetchForwarders() {
            try {
                const res = await fetch(API + '/api/forwarders');
                const data = await res.json();
                const list = document.getElementById('forwarderList');
                if (!data.forwarders || data.forwarders.length === 0) {
                    list.innerHTML = '<p style="color:#888;font-size:0.85rem;">Belum ada domain forwarder</p>';
                    return;
                }
                let html = '<table style="width:100%;font-size:0.85rem;"><tbody>';
                data.forwarders.forEach(fwd => {
                    const resolvers = fwd.addrs.join(', ');
                    html += `<tr>
                        <td style="padding:5px 0;"><strong>${fwd.name}</strong><br><span style="color:#888;">${resolvers}</span></td>
                        <td style="width:40px;text-align:right;">
                            <button class="btn btn-danger" style="padding:3px 8px;" onclick="deleteForwarder('${fwd.name}')">üóë</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { console.error('Forwarders fetch error', e); }
        }

        async function addForwarder() {
            const input = document.getElementById('forwarderInput').value.trim();
            if (!input) {
                showAlert('Masukkan domain dan resolver', 'error');
                return;
            }
            const parts = input.split(',').map(p => p.trim());
            if (parts.length < 2) {
                showAlert('Format: domain,resolver1,resolver2,...', 'error');
                return;
            }
            const name = parts[0];
            const addrs = parts.slice(1);

            const res = await fetch(API + '/api/forwarders', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, addrs })
            });
            const data = await res.json();
            if (data.success) {
                showAlert(data.message + ' - Klik Reload untuk menerapkan.', 'success');
                document.getElementById('forwarderInput').value = '';
                fetchForwarders();
            } else {
                showAlert(data.error || 'Gagal menambah forwarder', 'error');
            }
        }

        async function deleteForwarder(name) {
            if (!confirm(`Hapus forwarder untuk ${name}?`)) return;
            const res = await fetch(API + '/api/forwarder/delete', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const data = await res.json();
            if (data.success) {
                showAlert(data.message + ' - Klik Reload untuk menerapkan.', 'success');
                fetchForwarders();
            } else {
                showAlert(data.error || 'Gagal menghapus', 'error');
            }
        }

        async function reload() {
            const res = await fetch(API + '/api/reload', { method: 'POST' });
            const data = await res.json();
            showAlert(data.success ? 'Reloaded!' : data.error, data.success ? 'success' : 'error');
        }

        async function restart() {
            if (!confirm('Restart Unbound?')) return;
            const res = await fetch(API + '/api/restart', { method: 'POST' });
            const data = await res.json();
            showAlert(data.success ? 'Restarted!' : data.error, data.success ? 'success' : 'error');
        }

        async function addIp() {
            const iface = document.getElementById('ifaceSelect').value;
            const ip = document.getElementById('newIp').value;
            const prefix = document.getElementById('newPrefix').value;
            if (!ip) return showAlert('Enter IP address', 'error');
            const res = await fetch(API + '/api/interface', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ interface: iface, ip, prefix: parseInt(prefix) })
            });
            const data = await res.json();
            if (data.success) { showAlert('IP added!', 'success'); document.getElementById('newIp').value = ''; fetchInterfaces(); }
            else showAlert(data.error, 'error');
        }

        async function addAcl() {
            const network = document.getElementById('aclNetwork').value;
            const acl_action = document.getElementById('aclAction').value;
            if (!network) return showAlert('Enter network', 'error');
            const res = await fetch(API + '/api/acl', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'add', network, acl_action })
            });
            const data = await res.json();
            if (data.success) { showAlert('ACL added! Klik Reload untuk menerapkan.', 'success'); document.getElementById('aclNetwork').value = ''; fetchAcl(); }
            else showAlert(data.error, 'error');
        }

        async function removeAcl(network) {
            if (!confirm(`Remove ${network}?`)) return;
            const res = await fetch(API + '/api/acl', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'remove', network })
            });
            const data = await res.json();
            if (data.success) { showAlert('ACL removed! Klik Reload untuk menerapkan.', 'success'); fetchAcl(); }
            else showAlert(data.error, 'error');
        }

        function logout() { window.location.href = '/api/logout'; }
        function showPasswordModal() { document.getElementById('passwordModal').classList.add('show'); }
        function hidePasswordModal() { document.getElementById('passwordModal').classList.remove('show'); }

        async function changePassword() {
            const current = document.getElementById('currentPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirm = document.getElementById('confirmPass').value;
            if (newPass !== confirm) return showAlert('Passwords do not match', 'error');
            const res = await fetch(API + '/api/password', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current, new: newPass })
            });
            const data = await res.json();
            if (data.success) { showAlert('Password changed!', 'success'); hidePasswordModal(); }
            else showAlert(data.error, 'error');
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 3000);
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return typeof num === 'number' ? num.toFixed(1) : num.toString();
        }
    </script>
</body>

</html>